<script>
  "use strict";

  var test_seq = [make_note(69, 0.5), make_note(72, 1), make_note(76, 1)]

  var ctx = new AudioContext();
  var osc = ctx.createOscillator();
  var filter = ctx.createBiquadFilter();
  var amp = ctx.createGain();
  var sink = ctx.destination;

  osc.connect(filter);
  osc.type = "sawtooth";

  filter.connect(amp);
  filter.frequency.value = 880;
  filter.type = "lowpass";

  amp.connect(sink);
  amp.gain.value = 0;

  osc.start();

  function midi2freq(note) {
    return Math.pow(2, (note - 69) / 12) * 440;
  }

  function make_note(midi, duration) {
    return {
      "midi": midi,
      "duration": duration,
      "frequency": midi2freq(midi)
    };
  }

  function play_adsr(note, attack, decay, sustain, release) {
    osc.frequency.setValueAtTime(note.frequency, ctx.currentTime);
    amp.gain.cancelScheduledValues(ctx.currentTime);
    amp.gain.setValueAtTime(0, ctx.currentTime);

    //ADSR
    var attack_time = ctx.currentTime + attack;
    var decay_time = attack_time + decay;
    var sustain_time = decay_time + note.duration;
    var release_time = sustain_time + release;
    amp.gain.linearRampToValueAtTime(1, attack_time);
    amp.gain.linearRampToValueAtTime(sustain, decay_time);
    //amp.gain.linearRampToValueAtTime(sustain, sustain_time);
    amp.gain.linearRampToValueAtTime(0, release_time);
  }

  function play(note) {
    play_adsr(note, 0.1, 0.1, 0.5, 0.01);
  }

  function sequence(notes) {
    var time = 0;
    amp.gain.value = 1;
    osc.frequency.cancelScheduledValues(ctx.currentTime);

    for(var i = 0; i < notes.length; i += 1) {
      osc.frequency.setValueAtTime(notes[i].frequency, ctx.currentTime + 1);
      //time += notes[i].duration;
    }
  }

  function stop() {
    amp.gain.value = 0;
  }
</script>

<svg onmouseover="play(make_note(57, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#EB5757"/></svg>
<svg onmouseover="play(make_note(59, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#FFA02B"/></svg>
<svg onmouseover="play(make_note(60, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#EDD64A"/></svg>
<svg onmouseover="play(make_note(62, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#91DB37"/></svg>
<svg onmouseover="play(make_note(64, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#3FCBEB"/></svg>
<svg onmouseover="play(make_note(65, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#6796DB"/></svg>
<svg onmouseover="play(make_note(67, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#B279DB"/></svg>

<svg onmouseover="play(make_note(69, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#EB5757"/></svg>
<svg onmouseover="play(make_note(71, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#FFA02B"/></svg>
<svg onmouseover="play(make_note(72, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#EDD64A"/></svg>
<svg onmouseover="play(make_note(74, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#91DB37"/></svg>
<svg onmouseover="play(make_note(76, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#3FCBEB"/></svg>
<svg onmouseover="play(make_note(77, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#6796DB"/></svg>
<svg onmouseover="play(make_note(79, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#B279DB"/></svg>

<svg onmouseover="play(make_note(81, 0.5));" width="64" height="64"><rect height="64" width="64" fill="#EB5757"/></svg>
